{{define "body"}}
<div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
    <h1 class="page-header">
        <i class="fa fa-users"></i> Extracted Leads
    </h1>
    <div id="flashes" class="row"></div>
    
    <!-- Stats Row -->
    <div class="row" id="statsRow">
        <div class="col-md-3">
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <h3 class="panel-title">Total Leads</h3>
                </div>
                <div class="panel-body text-center">
                    <h2 id="totalLeads">0</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="panel panel-success">
                <div class="panel-heading">
                    <h3 class="panel-title">Imported</h3>
                </div>
                <div class="panel-body text-center">
                    <h2 id="importedLeads">0</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="panel panel-warning">
                <div class="panel-heading">
                    <h3 class="panel-title">Pending</h3>
                </div>
                <div class="panel-body text-center">
                    <h2 id="pendingLeads">0</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="panel panel-info">
                <div class="panel-heading">
                    <h3 class="panel-title">Active Jobs</h3>
                </div>
                <div class="panel-body text-center">
                    <h2 id="activeJobs">0</h2>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Filters -->
    <div class="row">
        <div class="col-md-12">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h5><i class="fa fa-filter"></i> Filters</h5>
                </div>
                <div class="panel-body">
                    <form class="form-inline" id="filterForm">
                        <div class="form-group">
                            <label for="filterProfile">Sending Profile:</label>
                            <select class="form-control" id="filterProfile">
                                <option value="">All Profiles</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="filterSource">Source:</label>
                            <select class="form-control" id="filterSource">
                                <option value="">All Sources</option>
                                <option value="inbox">Inbox</option>
                                <option value="sent">Sent</option>
                                <option value="all_mail">All Mail</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="filterStatus">Status:</label>
                            <select class="form-control" id="filterStatus">
                                <option value="">All</option>
                                <option value="pending">Pending</option>
                                <option value="imported">Imported</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="filterSearch">Search:</label>
                            <input type="text" class="form-control" id="filterSearch" placeholder="Email or name...">
                        </div>
                        <button type="submit" class="btn btn-primary"><i class="fa fa-search"></i> Filter</button>
                        <button type="button" class="btn btn-default" onclick="resetFilters()"><i class="fa fa-refresh"></i> Reset</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Actions -->
    <div class="row">
        <div class="col-md-12">
            <div class="btn-group">
                <button type="button" class="btn btn-success" onclick="openBulkImportModal()" id="bulkImportBtn" disabled>
                    <i class="fa fa-download"></i> Import Selected to Group
                </button>
                <button type="button" class="btn btn-danger" onclick="deleteSelectedLeads()" id="deleteSelectedBtn" disabled>
                    <i class="fa fa-trash"></i> Delete Selected
                </button>
                <button type="button" class="btn btn-info" onclick="exportLeads()">
                    <i class="fa fa-file-excel-o"></i> Export to CSV
                </button>
            </div>
        </div>
    </div>
    &nbsp;
    
    <!-- Loading -->
    <div id="loading">
        <i class="fa fa-spinner fa-spin fa-4x"></i>
    </div>
    
    <!-- Empty Message -->
    <div id="emptyMessage" class="row" style="display:none;">
        <div class="alert alert-info">
            <i class="fa fa-info-circle"></i> No leads extracted yet. Go to <a href="/sending_profiles">Sending Profiles</a> to configure IMAP and extract leads.
        </div>
    </div>
    
    <!-- Leads Table -->
    <div class="row">
        <table id="leadsTable" class="table table-striped table-hover" style="display:none;">
            <thead>
                <tr>
                    <th style="width: 30px;"><input type="checkbox" id="selectAllLeads"></th>
                    <th>Email</th>
                    <th>Name</th>
                    <th>Source</th>
                    <th>Profile</th>
                    <th>Status</th>
                    <th>Extracted</th>
                    <th style="width: 100px;">Actions</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
    
    <!-- Pagination -->
    <div class="row text-center" id="pagination" style="display:none;">
        <nav>
            <ul class="pagination">
            </ul>
        </nav>
    </div>
</div>

<!-- Bulk Import Modal -->
<div class="modal fade" id="bulkImportModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                <h4 class="modal-title"><i class="fa fa-download"></i> Import Leads to Group</h4>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="control-label">Import to:</label>
                    <div class="radio">
                        <label>
                            <input type="radio" name="bulkImportType" value="existing" checked onchange="toggleBulkImportType()">
                            Existing Group
                        </label>
                    </div>
                    <div class="radio">
                        <label>
                            <input type="radio" name="bulkImportType" value="new" onchange="toggleBulkImportType()">
                            Create New Group
                        </label>
                    </div>
                </div>
                <div class="form-group" id="bulkExistingGroupSelect">
                    <label class="control-label" for="bulkTargetGroup">Select Group:</label>
                    <select class="form-control" id="bulkTargetGroup">
                        <option value="">Loading groups...</option>
                    </select>
                </div>
                <div class="form-group" id="bulkNewGroupInput" style="display: none;">
                    <label class="control-label" for="bulkNewGroupName">New Group Name:</label>
                    <input type="text" class="form-control" id="bulkNewGroupName" placeholder="Enter group name">
                </div>
                <div class="checkbox">
                    <label>
                        <input type="checkbox" id="bulkMergeExisting" checked>
                        Merge with existing targets (skip duplicates)
                    </label>
                </div>
                <div class="alert alert-info">
                    <i class="fa fa-info-circle"></i> <span id="bulkSelectedCount">0</span> leads selected for import
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" data-dismiss="modal" class="btn btn-default">Cancel</button>
                <button type="button" class="btn btn-success" onclick="bulkImportLeads()">
                    <i class="fa fa-download"></i> Import Leads
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Extraction Jobs Panel -->
<div class="modal fade" id="jobsModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                <h4 class="modal-title"><i class="fa fa-tasks"></i> Extraction Jobs</h4>
            </div>
            <div class="modal-body">
                <table class="table table-striped" id="jobsTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Profile</th>
                            <th>Status</th>
                            <th>Progress</th>
                            <th>Leads Found</th>
                            <th>Started</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" data-dismiss="modal" class="btn btn-default">Close</button>
            </div>
        </div>
    </div>
</div>
{{end}}

{{define "scripts"}}
<script>
// Global state
var allLeads = [];
var currentPage = 0;
var perPage = 50;
var totalLeads = 0;
var profiles = {};

// Initialize
$(document).ready(function() {
    loadStats();
    loadProfiles();
    loadLeads();
    
    // Filter form submit
    $('#filterForm').on('submit', function(e) {
        e.preventDefault();
        currentPage = 0;
        loadLeads();
    });
    
    // Select all checkbox
    $('#selectAllLeads').on('change', function() {
        var checked = $(this).is(':checked');
        $('.lead-checkbox').prop('checked', checked);
        updateBulkButtons();
    });
    
    // Individual checkbox
    $(document).on('change', '.lead-checkbox', function() {
        updateBulkButtons();
    });
});

// Load stats
function loadStats() {
    $.get('/api/leads/stats', function(stats) {
        $('#totalLeads').text(stats.total || 0);
        $('#importedLeads').text(stats.imported || 0);
        $('#pendingLeads').text(stats.pending || 0);
        $('#activeJobs').text(stats.active_jobs || 0);
    });
}

// Load profiles for filter
function loadProfiles() {
    $.get('/api/smtp/', function(data) {
        var select = $('#filterProfile');
        data.forEach(function(profile) {
            profiles[profile.id] = profile.name;
            select.append('<option value="' + profile.id + '">' + escapeHtml(profile.name) + '</option>');
        });
    });
}

// Load leads
function loadLeads() {
    $('#loading').show();
    $('#leadsTable').hide();
    $('#emptyMessage').hide();
    
    var params = {
        page: currentPage,
        per_page: perPage,
        smtp_id: $('#filterProfile').val() || '',
        source: $('#filterSource').val() || '',
        status: $('#filterStatus').val() || '',
        search: $('#filterSearch').val() || ''
    };
    
    $.get('/api/leads/', params, function(response) {
        $('#loading').hide();
        
        allLeads = response.leads || [];
        totalLeads = response.total || 0;
        
        if (allLeads.length === 0) {
            $('#emptyMessage').show();
            $('#pagination').hide();
        } else {
            renderLeadsTable();
            renderPagination();
            $('#leadsTable').show();
            $('#pagination').show();
        }
    }).fail(function() {
        $('#loading').hide();
        $('#emptyMessage').html('<div class="alert alert-danger">Failed to load leads</div>').show();
    });
}

// Render leads table
function renderLeadsTable() {
    var tbody = $('#leadsTable tbody');
    var html = '';
    
    allLeads.forEach(function(lead) {
        var statusClass = lead.status === 'imported' ? 'success' : 'warning';
        var profileName = profiles[lead.smtp_id] || 'Unknown';
        
        html += '<tr data-id="' + lead.id + '">';
        html += '<td><input type="checkbox" class="lead-checkbox" value="' + lead.id + '"></td>';
        html += '<td>' + escapeHtml(lead.email) + '</td>';
        html += '<td>' + escapeHtml(lead.name || '-') + '</td>';
        html += '<td><span class="label label-' + getSourceLabel(lead.source) + '">' + escapeHtml(lead.source) + '</span></td>';
        html += '<td>' + escapeHtml(profileName) + '</td>';
        html += '<td><span class="label label-' + statusClass + '">' + escapeHtml(lead.status) + '</span></td>';
        html += '<td>' + formatDate(lead.created_at) + '</td>';
        html += '<td>';
        html += '<button class="btn btn-xs btn-danger" onclick="deleteLead(' + lead.id + ')"><i class="fa fa-trash"></i></button>';
        html += '</td>';
        html += '</tr>';
    });
    
    tbody.html(html);
    $('#selectAllLeads').prop('checked', false);
    updateBulkButtons();
}

// Render pagination
function renderPagination() {
    var totalPages = Math.ceil(totalLeads / perPage);
    var ul = $('#pagination ul');
    var html = '';
    
    // Previous
    html += '<li class="' + (currentPage === 0 ? 'disabled' : '') + '">';
    html += '<a href="#" onclick="goToPage(' + (currentPage - 1) + '); return false;">&laquo;</a>';
    html += '</li>';
    
    // Pages
    for (var i = 0; i < totalPages && i < 10; i++) {
        html += '<li class="' + (i === currentPage ? 'active' : '') + '">';
        html += '<a href="#" onclick="goToPage(' + i + '); return false;">' + (i + 1) + '</a>';
        html += '</li>';
    }
    
    // Next
    html += '<li class="' + (currentPage >= totalPages - 1 ? 'disabled' : '') + '">';
    html += '<a href="#" onclick="goToPage(' + (currentPage + 1) + '); return false;">&raquo;</a>';
    html += '</li>';
    
    ul.html(html);
}

// Go to page
function goToPage(page) {
    var totalPages = Math.ceil(totalLeads / perPage);
    if (page < 0 || page >= totalPages) return;
    currentPage = page;
    loadLeads();
}

// Reset filters
function resetFilters() {
    $('#filterProfile').val('');
    $('#filterSource').val('');
    $('#filterStatus').val('');
    $('#filterSearch').val('');
    currentPage = 0;
    loadLeads();
}

// Update bulk action buttons
function updateBulkButtons() {
    var count = $('.lead-checkbox:checked').length;
    $('#bulkImportBtn').prop('disabled', count === 0);
    $('#deleteSelectedBtn').prop('disabled', count === 0);
    $('#bulkSelectedCount').text(count);
}

// Open bulk import modal
function openBulkImportModal() {
    var count = $('.lead-checkbox:checked').length;
    if (count === 0) {
        alert('Please select at least one lead');
        return;
    }
    
    $('#bulkSelectedCount').text(count);
    loadGroupsForBulkImport();
    $('#bulkImportModal').modal('show');
}

// Load groups for bulk import
function loadGroupsForBulkImport() {
    $.get('/api/groups/', function(groups) {
        var select = $('#bulkTargetGroup');
        select.empty();
        select.append('<option value="">-- Select a group --</option>');
        groups.forEach(function(group) {
            select.append('<option value="' + group.id + '">' + escapeHtml(group.name) + '</option>');
        });
    });
}

// Toggle bulk import type
function toggleBulkImportType() {
    var type = $('input[name="bulkImportType"]:checked').val();
    if (type === 'existing') {
        $('#bulkExistingGroupSelect').show();
        $('#bulkNewGroupInput').hide();
    } else {
        $('#bulkExistingGroupSelect').hide();
        $('#bulkNewGroupInput').show();
    }
}

// Bulk import leads
function bulkImportLeads() {
    var type = $('input[name="bulkImportType"]:checked').val();
    var groupId = null;
    var groupName = null;
    
    if (type === 'existing') {
        groupId = $('#bulkTargetGroup').val();
        if (!groupId) {
            alert('Please select a group');
            return;
        }
    } else {
        groupName = $('#bulkNewGroupName').val().trim();
        if (!groupName) {
            alert('Please enter a group name');
            return;
        }
    }
    
    var leadIds = [];
    $('.lead-checkbox:checked').each(function() {
        leadIds.push(parseInt($(this).val()));
    });
    
    var data = {
        lead_ids: leadIds,
        merge: $('#bulkMergeExisting').is(':checked')
    };
    
    if (groupId) {
        data.group_id = parseInt(groupId);
    } else {
        data.group_name = groupName;
    }
    
    $.ajax({
        url: '/api/leads/import',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function(response) {
            alert('Successfully imported ' + response.imported + ' leads!');
            $('#bulkImportModal').modal('hide');
            loadLeads();
            loadStats();
        },
        error: function(xhr) {
            var msg = 'Failed to import leads';
            if (xhr.responseJSON && xhr.responseJSON.message) {
                msg = xhr.responseJSON.message;
            }
            alert(msg);
        }
    });
}

// Delete single lead
function deleteLead(id) {
    if (!confirm('Are you sure you want to delete this lead?')) return;
    
    $.ajax({
        url: '/api/leads/' + id,
        method: 'DELETE',
        success: function() {
            loadLeads();
            loadStats();
        },
        error: function() {
            alert('Failed to delete lead');
        }
    });
}

// Delete selected leads
function deleteSelectedLeads() {
    var count = $('.lead-checkbox:checked').length;
    if (count === 0) return;
    
    if (!confirm('Are you sure you want to delete ' + count + ' leads?')) return;
    
    var leadIds = [];
    $('.lead-checkbox:checked').each(function() {
        leadIds.push(parseInt($(this).val()));
    });
    
    $.ajax({
        url: '/api/leads/bulk-delete',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ lead_ids: leadIds }),
        success: function() {
            loadLeads();
            loadStats();
        },
        error: function() {
            alert('Failed to delete leads');
        }
    });
}

// Export leads to CSV
function exportLeads() {
    var params = {
        smtp_id: $('#filterProfile').val() || '',
        source: $('#filterSource').val() || '',
        status: $('#filterStatus').val() || '',
        search: $('#filterSearch').val() || '',
        format: 'csv'
    };
    
    window.location.href = '/api/leads/export?' + $.param(params);
}

// Helper functions
function getSourceLabel(source) {
    switch (source) {
        case 'inbox': return 'primary';
        case 'sent': return 'success';
        case 'all_mail': return 'info';
        default: return 'default';
    }
}

function formatDate(dateStr) {
    if (!dateStr) return '-';
    var date = new Date(dateStr);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
}

function escapeHtml(text) {
    if (!text) return '';
    var div = document.createElement('div');
    div.appendChild(document.createTextNode(text));
    return div.innerHTML;
}
</script>
{{end}}
