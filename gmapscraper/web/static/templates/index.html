<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GMaps Scraper - Data Extraction Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/htmx/1.9.6/htmx.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            900: '#0f0f23',
                            800: '#1a1a2e',
                            700: '#16213e',
                            600: '#1f2937',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%); }
        .glass-card {
            background: rgba(31, 41, 55, 0.6);
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(75, 85, 99, 0.3);
        }
        .glass-sidebar {
            background: rgba(17, 24, 39, 0.8);
            -webkit-backdrop-filter: blur(16px);
            backdrop-filter: blur(16px);
            border-right: 1px solid rgba(75, 85, 99, 0.3);
        }
        .glass-input {
            background: rgba(17, 24, 39, 0.6);
            border: 1px solid rgba(75, 85, 99, 0.4);
        }
        .glass-input:focus {
            border-color: rgba(139, 92, 246, 0.6);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }
        .btn-primary {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #7c3aed 0%, #4f46e5 100%);
        }
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        .btn-success:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        .btn-danger:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        }
        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        .extraction-gradient {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 50%, #4f46e5 100%);
        }
        .table-row:hover {
            background: rgba(139, 92, 246, 0.1);
        }
        .status-ok { background: linear-gradient(135deg, #10b981, #059669); }
        .status-pending { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .status-working { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .status-failed, .status-error { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .status-stopped { background: linear-gradient(135deg, #6b7280, #4b5563); }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: rgba(31, 41, 55, 0.3); }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: rgba(139, 92, 246, 0.5); border-radius: 3px; }
        .animate-pulse-slow { animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        details summary::-webkit-details-marker { display: none; }
        details summary::before {
            content: '+';
            display: inline-block;
            width: 20px;
            font-weight: bold;
            color: #8b5cf6;
        }
        details[open] summary::before { content: '-'; }
        .htmx-indicator { display: none; }
        .htmx-request .htmx-indicator { display: inline-block; }
        .htmx-request.htmx-indicator { display: inline-block; }
        /* Mobile optimizations */
        @media (max-width: 1023px) { aside.glass-sidebar { height: calc(100vh - 60px); } }
        @media (max-width: 640px) {
            .extraction-gradient h3 { font-size: 1rem; }
            .extraction-gradient p { font-size: 0.75rem; }
        }
        /* Touch-friendly buttons on mobile */
        @media (hover: none) {
            button, a.btn-success, a.btn-danger { min-height: 44px; }
        }
        /* Hide elements until Alpine.js initializes */
        [x-cloak] { display: none !important; }
        /* Mobile sidebar backdrop - minimal, subtle */
        .sidebar-backdrop {
            background: linear-gradient(to right, rgba(0,0,0,0.4) 0%, rgba(0,0,0,0.2) 50%, transparent 100%);
        }
        /* Sidebar width on mobile */
        @media (max-width: 1023px) {
            .mobile-sidebar-width { width: 85%; max-width: 320px; }
        }
        /* Jobs table switches to cards on small screens */
        @media (max-width: 768px) {
            #job-table { table-layout: auto; }
            #job-table thead { display: none; }
            #job-table tbody { display: flex; flex-direction: column; gap: 12px; }
            #job-table tr {
                display: block;
                background: rgba(17, 24, 39, 0.75);
                border: 1px solid rgba(75, 85, 99, 0.35);
                border-radius: 14px;
                padding: 12px 14px;
                box-shadow: 0 15px 35px rgba(0, 0, 0, 0.25);
            }
            #job-table td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                border: none;
                padding: 8px 0;
                width: 100%;
            }
            #job-table td::before {
                content: attr(data-label);
                text-transform: uppercase;
                letter-spacing: 0.05em;
                font-size: 0.65rem;
                color: #9ca3af;
                margin-right: 12px;
                flex: 0 0 120px;
            }
            #job-table td:first-child { padding-top: 0; }
            #job-table td:last-child { padding-bottom: 0; }
            #job-table td.actions {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
                padding-top: 10px;
            }
            #job-table td.actions::before { content: 'Actions'; }
            #job-table td.actions .flex { width: 100%; }
        }
    </style>
</head>
<body
    class="min-h-screen text-gray-100 font-sans"
    x-data="{
        sidebarOpen: window.innerWidth >= 1024,
        extractionOpen: window.innerWidth >= 768,
        syncLayout() {
            this.sidebarOpen = window.innerWidth >= 1024;
            this.extractionOpen = window.innerWidth >= 768;
        }
    }"
    x-init="this.syncLayout(); window.addEventListener('resize', () => this.syncLayout())"
>
    <div
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-30 transition-opacity duration-300 lg:hidden"
        x-show="sidebarOpen"
        x-transition.opacity
        @click="sidebarOpen = false"
        x-cloak
    ></div>
    <div class="flex min-h-screen flex-col lg:flex-row">
        <!-- Mobile Header -->
        <div class="lg:hidden glass-sidebar p-4 flex items-center justify-between sticky top-0 z-50">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg extraction-gradient flex items-center justify-center">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                    </svg>
                </div>
                <span class="text-lg font-bold text-white">GMaps Scraper</span>
            </div>
            <button type="button" @click="sidebarOpen = !sidebarOpen" class="glass-card p-2 rounded-lg hover:bg-purple-500/20 transition-all" title="Toggle menu" aria-label="Toggle menu">
                <svg x-show="!sidebarOpen" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                </svg>
                <svg x-show="sidebarOpen" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <!-- Sidebar -->
        <aside class="glass-sidebar mobile-sidebar-width lg:w-80 flex-shrink-0 overflow-y-auto scrollbar-thin fixed lg:relative inset-y-0 left-0 top-[60px] lg:top-0 z-40 transition-transform duration-300 shadow-2xl lg:shadow-none" :class="{ '-translate-x-full lg:translate-x-0': !sidebarOpen, 'translate-x-0': sidebarOpen }">
            <div class="p-4 lg:p-6">
                <!-- Close button for mobile sidebar -->
                <div class="lg:hidden flex justify-end mb-4">
                    <button type="button" @click="sidebarOpen = false" class="glass-card p-2 rounded-lg hover:bg-purple-500/20 transition-all" title="Close menu" aria-label="Close menu">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <!-- Logo/Title (hidden on mobile, shown in mobile header) -->
                <div class="hidden lg:flex items-center gap-3 mb-8">
                    <div class="w-10 h-10 rounded-xl extraction-gradient flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-white">GMaps Scraper</h1>
                        <p class="text-xs text-gray-400">Data Extraction Suite</p>
                    </div>
                </div>

                <!-- Quick Links -->
                <div class="flex gap-2 mb-6">
                    <a href="/api/docs" target="_blank" class="flex-1 glass-card rounded-lg px-3 py-2 text-center text-sm text-gray-300 hover:text-white hover:border-purple-500/50 transition-all">
                        API Docs
                    </a>
                </div>

                <!-- Error Container -->
                <div id="error-container" class="mb-4 hidden">
                    <div class="bg-red-500/20 border border-red-500/50 rounded-lg p-3 text-red-300 text-sm"></div>
                </div>

                <!-- Scrape Form -->
                <form
                    hx-post="/scrape"
                    hx-target="#job-table tbody"
                    hx-swap="beforeend"
                    hx-indicator="#spinner"
                    hx-on::before-request="document.getElementById('error-container').classList.add('hidden')"
                    hx-on::after-request="if(!event.detail.successful) { document.getElementById('error-container').classList.remove('hidden'); document.getElementById('error-container').querySelector('div').textContent = event.detail.xhr.responseText; }"
                    class="space-y-4"
                >
                    <!-- Job Details -->
                    <div class="glass-card rounded-xl p-4">
                        <h3 class="text-sm font-semibold text-purple-400 mb-4 flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                            </svg>
                            Job Details
                        </h3>
                        <div class="space-y-3">
                            <div>
                                <label for="name" class="block text-xs text-gray-400 mb-1">Job Name</label>
                                <input type="text" id="name" name="name" value="{{.Name}}"
                                    class="w-full glass-input rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none transition-all">
                            </div>
                            <div>
                                <label for="keywords" class="block text-xs text-gray-400 mb-1">Keywords</label>
                                <textarea id="keywords" name="keywords" rows="6"
                                    class="w-full glass-input rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none transition-all resize-none">{{ .KeywordsString }}</textarea>
                            </div>
                            <div>
                                <label for="lang" class="block text-xs text-gray-400 mb-1">Language</label>
                                <input type="text" id="lang" name="lang" value="{{.Language}}"
                                    class="w-full glass-input rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none transition-all">
                            </div>
                        </div>
                    </div>

                    <!-- Location Settings -->
                    <details class="glass-card rounded-xl overflow-hidden" open>
                        <summary class="px-4 py-3 cursor-pointer text-sm font-semibold text-purple-400 hover:bg-purple-500/10 transition-all flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                            </svg>
                            Location Settings (USA)
                        </summary>
                        <div class="p-4 pt-2 space-y-3">
                            <div>
                                <label for="city" class="block text-xs text-gray-400 mb-1">City</label>
                                <input type="text" id="city" name="city" placeholder="e.g., New York, Los Angeles"
                                    class="w-full glass-input rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none transition-all">
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                <div>
                                    <label for="state" class="block text-xs text-gray-400 mb-1">State</label>
                                    <select id="state" name="state" class="w-full glass-input rounded-lg px-3 py-2 text-sm text-white focus:outline-none transition-all">
                                        <option value="">Select State</option>
                                        <option value="AL">Alabama</option>
                                        <option value="AK">Alaska</option>
                                        <option value="AZ">Arizona</option>
                                        <option value="AR">Arkansas</option>
                                        <option value="CA">California</option>
                                        <option value="CO">Colorado</option>
                                        <option value="CT">Connecticut</option>
                                        <option value="DE">Delaware</option>
                                        <option value="FL">Florida</option>
                                        <option value="GA">Georgia</option>
                                        <option value="HI">Hawaii</option>
                                        <option value="ID">Idaho</option>
                                        <option value="IL">Illinois</option>
                                        <option value="IN">Indiana</option>
                                        <option value="IA">Iowa</option>
                                        <option value="KS">Kansas</option>
                                        <option value="KY">Kentucky</option>
                                        <option value="LA">Louisiana</option>
                                        <option value="ME">Maine</option>
                                        <option value="MD">Maryland</option>
                                        <option value="MA">Massachusetts</option>
                                        <option value="MI">Michigan</option>
                                        <option value="MN">Minnesota</option>
                                        <option value="MS">Mississippi</option>
                                        <option value="MO">Missouri</option>
                                        <option value="MT">Montana</option>
                                        <option value="NE">Nebraska</option>
                                        <option value="NV">Nevada</option>
                                        <option value="NH">New Hampshire</option>
                                        <option value="NJ">New Jersey</option>
                                        <option value="NM">New Mexico</option>
                                        <option value="NY">New York</option>
                                        <option value="NC">North Carolina</option>
                                        <option value="ND">North Dakota</option>
                                        <option value="OH">Ohio</option>
                                        <option value="OK">Oklahoma</option>
                                        <option value="OR">Oregon</option>
                                        <option value="PA">Pennsylvania</option>
                                        <option value="RI">Rhode Island</option>
                                        <option value="SC">South Carolina</option>
                                        <option value="SD">South Dakota</option>
                                        <option value="TN">Tennessee</option>
                                        <option value="TX">Texas</option>
                                        <option value="UT">Utah</option>
                                        <option value="VT">Vermont</option>
                                        <option value="VA">Virginia</option>
                                        <option value="WA">Washington</option>
                                        <option value="WV">West Virginia</option>
                                        <option value="WI">Wisconsin</option>
                                        <option value="WY">Wyoming</option>
                                        <option value="DC">Washington D.C.</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="zipcode" class="block text-xs text-gray-400 mb-1">Zip Code</label>
                                    <input type="text" id="zipcode" name="zipcode" placeholder="e.g., 10001" pattern="[0-9]{5}" maxlength="5"
                                        class="w-full glass-input rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none transition-all">
                                </div>
                            </div>
                            <button type="button" onclick="geocodeAddress()"
                                class="w-full btn-success text-white rounded-lg px-4 py-2 text-sm font-medium transition-all hover:shadow-lg hover:shadow-green-500/25">
                                Get Coordinates from Address
                            </button>
                            <div id="geocode-status" class="hidden text-sm p-2 rounded-lg"></div>
                            <div class="glass-input rounded-lg p-3 text-xs">
                                <span class="text-gray-400">Current Coordinates:</span>
                                <div class="mt-1 text-gray-300">
                                    Lat: <span id="lat-display" class="text-purple-400">{{.Lat}}</span> |
                                    Lon: <span id="lon-display" class="text-purple-400">{{.Lon}}</span>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                <div>
                                    <label for="zoom" class="block text-xs text-gray-400 mb-1">Zoom Level</label>
                                    <input type="number" id="zoom" name="zoom" value="{{.Zoom}}" min="1" max="21"
                                        class="w-full glass-input rounded-lg px-3 py-2 text-sm text-white focus:outline-none transition-all">
                                    <p class="text-xs text-gray-500 mt-1">6-10: wide, 14-18: narrow</p>
                                </div>
                                <div>
                                    <label for="maxresults" class="block text-xs text-gray-400 mb-1">Max Results</label>
                                    <input type="number" id="maxresults" name="maxresults" value="{{.MaxResults}}" min="0" max="1000"
                                        class="w-full glass-input rounded-lg px-3 py-2 text-sm text-white focus:outline-none transition-all">
                                    <p class="text-xs text-gray-500 mt-1">0 = unlimited</p>
                                </div>
                            </div>
                            <input type="hidden" id="latitude" name="latitude" value="{{.Lat}}">
                            <input type="hidden" id="longitude" name="longitude" value="{{.Lon}}">
                        </div>
                    </details>

                    <!-- Advanced Options -->
                    <details class="glass-card rounded-xl overflow-hidden">
                        <summary class="px-4 py-3 cursor-pointer text-sm font-semibold text-purple-400 hover:bg-purple-500/10 transition-all flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                            Advanced Options
                        </summary>
                        <div class="p-4 pt-2 space-y-3">
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input type="checkbox" id="fastmode" name="fastmode" {{if .FastMode}}checked{{end}}
                                    class="w-4 h-4 rounded border-gray-600 bg-gray-700 text-purple-500 focus:ring-purple-500">
                                <span class="text-sm text-gray-300">Fast Mode (BETA)</span>
                            </label>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                <div>
                                    <label for="radius" class="block text-xs text-gray-400 mb-1">Radius (m)</label>
                                    <input type="number" id="radius" name="radius" value="{{.Radius}}"
                                        class="w-full glass-input rounded-lg px-3 py-2 text-sm text-white focus:outline-none transition-all">
                                </div>
                                <div>
                                    <label for="depth" class="block text-xs text-gray-400 mb-1">Depth</label>
                                    <input type="number" id="depth" name="depth" value="{{.Depth}}"
                                        class="w-full glass-input rounded-lg px-3 py-2 text-sm text-white focus:outline-none transition-all">
                                </div>
                            </div>
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input type="checkbox" id="email" name="email" {{if .Email}}checked{{end}}
                                    class="w-4 h-4 rounded border-gray-600 bg-gray-700 text-purple-500 focus:ring-purple-500">
                                <span class="text-sm text-gray-300">Fetch Emails</span>
                            </label>
                            <div>
                                <label for="maxtime" class="block text-xs text-gray-400 mb-1">Max Job Time</label>
                                <input type="text" id="maxtime" name="maxtime" value="{{.MaxTime}}"
                                    class="w-full glass-input rounded-lg px-3 py-2 text-sm text-white focus:outline-none transition-all">
                            </div>
                        </div>
                    </details>

                    <!-- Proxies -->
                    <details class="glass-card rounded-xl overflow-hidden">
                        <summary class="px-4 py-3 cursor-pointer text-sm font-semibold text-purple-400 hover:bg-purple-500/10 transition-all flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                            </svg>
                            Proxies
                        </summary>
                        <div class="p-4 pt-2">
                            <p class="text-xs text-gray-500 mb-2">One per line. Examples: https://user:pass@proxy:443, socks5://127.0.0.1:8000</p>
                            <textarea id="proxies" name="proxies" rows="4"
                                class="w-full glass-input rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none transition-all resize-none">{{.ProxiesString}}</textarea>
                        </div>
                    </details>

                    <!-- Commercial API -->
                    <details class="glass-card rounded-xl overflow-hidden">
                        <summary class="px-4 py-3 cursor-pointer text-sm font-semibold text-purple-400 hover:bg-purple-500/10 transition-all flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                            </svg>
                            Commercial API Mode
                        </summary>
                        <div class="p-4 pt-2 space-y-3">
                            <div class="bg-blue-500/20 border border-blue-500/30 rounded-lg p-3 text-xs text-blue-300">
                                Use the commercial GMaps Extractor API for faster, more reliable results.
                                <a href="https://gmapsextractor.com/dashboard/cloud/" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:underline">Get API key</a>
                            </div>
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input type="checkbox" id="useapi" name="useapi" {{if .UseAPI}}checked{{end}} onchange="toggleAPIFields()"
                                    class="w-4 h-4 rounded border-gray-600 bg-gray-700 text-purple-500 focus:ring-purple-500">
                                <span class="text-sm text-gray-300">Use Commercial API</span>
                            </label>
                            <div id="api-fields" class="hidden space-y-3">
                                <div>
                                    <label for="apikey" class="block text-xs text-gray-400 mb-1">API Key</label>
                                    <input type="password" id="apikey" name="apikey" value="{{.APIKey}}" placeholder="Enter your API key"
                                        class="w-full glass-input rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none transition-all">
                                </div>
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" id="apiextra" name="apiextra" {{if .APIExtra}}checked{{end}}
                                        class="w-4 h-4 rounded border-gray-600 bg-gray-700 text-purple-500 focus:ring-purple-500">
                                    <span class="text-sm text-gray-300">Include Emails & Social Links</span>
                                </label>
                                <div>
                                    <label for="country" class="block text-xs text-gray-400 mb-1">Country</label>
                                    <select id="country" name="country" class="w-full glass-input rounded-lg px-3 py-2 text-sm text-white focus:outline-none transition-all">
                                        <option value="us" {{if eq .Country "us"}}selected{{end}}>United States</option>
                                        <option value="uk" {{if eq .Country "uk"}}selected{{end}}>United Kingdom</option>
                                        <option value="ca" {{if eq .Country "ca"}}selected{{end}}>Canada</option>
                                        <option value="au" {{if eq .Country "au"}}selected{{end}}>Australia</option>
                                        <option value="de" {{if eq .Country "de"}}selected{{end}}>Germany</option>
                                        <option value="fr" {{if eq .Country "fr"}}selected{{end}}>France</option>
                                        <option value="es" {{if eq .Country "es"}}selected{{end}}>Spain</option>
                                        <option value="it" {{if eq .Country "it"}}selected{{end}}>Italy</option>
                                        <option value="in" {{if eq .Country "in"}}selected{{end}}>India</option>
                                        <option value="br" {{if eq .Country "br"}}selected{{end}}>Brazil</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </details>

                    <!-- Submit Button -->
                    <button type="submit" class="w-full btn-primary text-white rounded-xl px-4 py-3 font-semibold transition-all hover:shadow-lg hover:shadow-purple-500/25 flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                        Start Scraping
                    </button>
                </form>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto scrollbar-thin p-4 lg:p-6 pt-2 lg:pt-6">
            <!-- Header -->
            <div class="flex items-center justify-between mb-4 lg:mb-6">
                <h2 class="text-xl lg:text-2xl font-bold text-white">Jobs Dashboard</h2>
                <div id="spinner" class="htmx-indicator">
                    <svg class="animate-spin h-6 w-6 text-purple-500" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
            </div>

            <!-- Data Extraction Panel -->
            <div class="extraction-gradient rounded-xl lg:rounded-2xl p-4 lg:p-6 mb-4 lg:mb-6 shadow-xl shadow-purple-500/20">
                <!-- Header - clickable on mobile to toggle -->
                <div class="flex items-center justify-between cursor-pointer md:cursor-default" @click="if(window.innerWidth < 768) extractionOpen = !extractionOpen">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-white">Data Extraction</h3>
                            <p class="text-sm text-white/70">Extract phones & emails from completed jobs</p>
                        </div>
                    </div>
                    <!-- Mobile toggle indicator -->
                    <button type="button" class="md:hidden bg-white/20 rounded-lg p-2 hover:bg-white/30 transition-all" aria-label="Toggle extraction panel">
                        <svg class="w-5 h-5 text-white transition-transform duration-300" :class="{ 'rotate-180': extractionOpen }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                </div>
                <!-- Collapsible content -->
                <div x-show="extractionOpen" x-collapse x-cloak class="mt-4">

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 lg:gap-6">
                    <!-- From Selected Jobs -->
                    <div class="bg-white/10 rounded-xl p-4 backdrop-blur">
                        <h4 class="text-sm font-semibold text-white/90 mb-3">From Selected Jobs</h4>
                        <div class="flex flex-wrap gap-2 mb-3">
                            <select id="phone-format" title="Phone number format" aria-label="Phone number format" class="bg-white/90 text-gray-800 rounded-lg px-3 py-2 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-white/50">
                                <option value="standard">(XXX) XXX-XXXX</option>
                                <option value="dashes">XXX-XXX-XXXX</option>
                                <option value="dots">XXX.XXX.XXXX</option>
                                <option value="spaces">XXX XXX XXXX</option>
                                <option value="plain">XXXXXXXXXX</option>
                                <option value="plus1">+1 XXX-XXX-XXXX</option>
                                <option value="plus1_plain">+1XXXXXXXXXX</option>
                                <option value="intl">+1 (XXX) XXX-XXXX</option>
                            </select>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button type="button" onclick="extractData('phones')" class="bg-white/90 hover:bg-white text-gray-800 rounded-lg px-4 py-2 text-sm font-medium transition-all hover:shadow-lg flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                                </svg>
                                Phones
                            </button>
                            <button type="button" onclick="extractData('emails')" class="bg-white/90 hover:bg-white text-gray-800 rounded-lg px-4 py-2 text-sm font-medium transition-all hover:shadow-lg flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                </svg>
                                Emails
                            </button>
                            <button type="button" onclick="toggleSelectAll(true)" class="border-2 border-white/50 hover:border-white text-white rounded-lg px-4 py-2 text-sm font-medium transition-all flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                Select All
                            </button>
                        </div>
                    </div>

                    <!-- GoPhish Export -->
                    <div class="bg-white/10 rounded-xl p-4 backdrop-blur">
                        <h4 class="text-sm font-semibold text-white/90 mb-3">GoPhish Export</h4>
                        <p class="text-xs text-white/60 mb-3">Export selected jobs in GoPhish CSV format</p>
                        <div class="flex flex-wrap gap-2">
                            <button type="button" onclick="extractForGophish('emails')" class="bg-green-500/90 hover:bg-green-500 text-white rounded-lg px-4 py-2 text-sm font-medium transition-all hover:shadow-lg flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                </svg>
                                Emails for GoPhish
                            </button>
                            <button type="button" onclick="extractForGophish('phones')" class="bg-green-500/90 hover:bg-green-500 text-white rounded-lg px-4 py-2 text-sm font-medium transition-all hover:shadow-lg flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                                </svg>
                                Phones for GoPhish
                            </button>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 lg:gap-6 mt-4">
                    <!-- CSV Upload - Plain Text -->
                    <div class="bg-white/10 rounded-xl p-4 backdrop-blur">
                        <h4 class="text-sm font-semibold text-white/90 mb-3">CSV Upload (Plain Text)</h4>
                        <p class="text-xs text-white/60 mb-3">Extract phones or emails as plain text list</p>
                        <form id="csv-upload-form" enctype="multipart/form-data">
                            <input type="file" id="csv-file" name="csv_file" accept=".csv" title="Select CSV file to upload" aria-label="Select CSV file to upload"
                                class="w-full mb-3 text-sm text-white/80 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-white/90 file:text-gray-800 hover:file:bg-white cursor-pointer">
                            <div class="flex flex-wrap gap-2">
                                <button type="button" onclick="uploadAndExtract('phones')" class="bg-white/90 hover:bg-white text-gray-800 rounded-lg px-4 py-2 text-sm font-medium transition-all hover:shadow-lg flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                                    </svg>
                                    Phones
                                </button>
                                <button type="button" onclick="uploadAndExtract('emails')" class="bg-white/90 hover:bg-white text-gray-800 rounded-lg px-4 py-2 text-sm font-medium transition-all hover:shadow-lg flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                    </svg>
                                    Emails
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- CSV Upload - GoPhish Format (Batch) -->
                    <div class="bg-white/10 rounded-xl p-4 backdrop-blur">
                        <h4 class="text-sm font-semibold text-white/90 mb-3">CSV Upload (GoPhish Format)</h4>
                        <p class="text-xs text-white/60 mb-3">Upload multiple CSVs for batch processing</p>
                        <form id="csv-gophish-form" enctype="multipart/form-data">
                            <input type="file" id="csv-gophish-files" name="csv_files" accept=".csv" multiple title="Select CSV files for GoPhish export" aria-label="Select CSV files for GoPhish export"
                                class="w-full mb-2 text-sm text-white/80 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-white/90 file:text-gray-800 hover:file:bg-white cursor-pointer">
                            <p id="csv-gophish-count" class="text-xs text-purple-400 mb-3 hidden">0 files selected</p>
                            <div class="flex flex-wrap gap-2">
                                <button type="button" onclick="uploadForGophish('emails')" class="bg-green-500/90 hover:bg-green-500 text-white rounded-lg px-4 py-2 text-sm font-medium transition-all hover:shadow-lg flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                    </svg>
                                    Emails for GoPhish
                                </button>
                                <button type="button" onclick="uploadForGophish('phones')" class="bg-green-500/90 hover:bg-green-500 text-white rounded-lg px-4 py-2 text-sm font-medium transition-all hover:shadow-lg flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                                    </svg>
                                    Phones for GoPhish
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                </div><!-- End collapsible content -->
            </div>

            <!-- Jobs Table -->
            <div class="glass-card rounded-xl lg:rounded-2xl overflow-hidden">
                <div class="overflow-x-auto">
                <table id="job-table" class="w-full table-fixed">
                    <thead class="hidden md:table-header-group">
                        <tr class="border-b border-gray-700/50 bg-gray-800/50">
                            <th class="px-4 py-3 text-left" style="width: 50px;">
                                <input type="checkbox" id="select-all-checkbox" onclick="toggleSelectAll()" title="Select all completed jobs" aria-label="Select all completed jobs"
                                    style="width:18px;height:18px;accent-color:#8b5cf6;cursor:pointer;">
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider" style="width: 120px;">ID</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider" style="width: 150px;">Name</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider" style="width: 180px;">Date</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider" style="width: 80px;">Status</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider" style="min-width: 150px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody hx-get="/jobs" hx-trigger="load, every 10s">
                        <!-- Job rows inserted by HTMX -->
                    </tbody>
                </table>
                </div>

                <!-- Empty State -->
                <div id="empty-state" class="hidden py-12 text-center">
                    <svg class="mx-auto h-12 w-12 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                    </svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-300">No jobs yet</h3>
                    <p class="mt-1 text-sm text-gray-500">Get started by creating a new scraping job.</p>
                </div>
            </div>
        </main>
    </div>

<script>
// Geocoding (uses backend proxy to avoid CORS issues)
async function geocodeAddress() {
    const city = document.getElementById('city').value.trim();
    const stateSelect = document.getElementById('state');
    const state = stateSelect.value;
    const stateName = stateSelect.options[stateSelect.selectedIndex].text;
    const zipcode = document.getElementById('zipcode').value.trim();
    const statusDiv = document.getElementById('geocode-status');
    const geocodeBtn = document.querySelector('.btn-success');

    if (!city && !zipcode) {
        showStatus('Please enter at least a city or zip code', 'error');
        return;
    }

    geocodeBtn.disabled = true;
    geocodeBtn.innerHTML = '<svg class="animate-spin h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Looking up...';

    try {
        let result = null;

        // Try zip code first (via backend proxy)
        if (zipcode && zipcode.length === 5) {
            showStatus('Searching by zip code: ' + zipcode, 'info');
            const zipResponse = await fetch(`/geocode?postalcode=${zipcode}&country=us`);
            if (zipResponse.ok) {
                const zipData = await zipResponse.json();
                if (zipData && zipData.length > 0) result = zipData[0];
            }
        }

        // Try city + state (via backend proxy)
        if (!result && city && state) {
            showStatus('Searching by city and state: ' + city + ', ' + stateName, 'info');
            const cityStateQuery = encodeURIComponent(`${city}, ${stateName}, USA`);
            const cityResponse = await fetch(`/geocode?q=${cityStateQuery}`);
            if (cityResponse.ok) {
                const cityData = await cityResponse.json();
                if (cityData && cityData.length > 0) result = cityData[0];
            }
        }

        // Fallback: full address search (via backend proxy)
        if (!result) {
            let addressParts = [];
            if (city) addressParts.push(city);
            if (stateName && stateName !== 'Select State') addressParts.push(stateName);
            if (zipcode) addressParts.push(zipcode);
            addressParts.push('USA');
            const address = addressParts.join(', ');
            showStatus('Searching for: ' + address, 'info');
            const encodedAddress = encodeURIComponent(address);
            const response = await fetch(`/geocode?q=${encodedAddress}`);
            if (response.ok) {
                const data = await response.json();
                if (data && data.length > 0) result = data[0];
            }
        }

        if (result) {
            const lat = parseFloat(result.lat).toFixed(7);
            const lon = parseFloat(result.lon).toFixed(7);
            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lon;
            document.getElementById('lat-display').textContent = lat;
            document.getElementById('lon-display').textContent = lon;
            showStatus('Found: ' + result.display_name, 'success');
        } else {
            showStatus('Location not found. Try a different address.', 'error');
        }
    } catch (error) {
        console.error('Geocoding error:', error);
        showStatus('Error: ' + error.message, 'error');
    } finally {
        geocodeBtn.disabled = false;
        geocodeBtn.innerHTML = 'Get Coordinates from Address';
    }
}

function showStatus(message, type) {
    const statusDiv = document.getElementById('geocode-status');
    statusDiv.textContent = message;
    statusDiv.classList.remove('hidden', 'bg-green-500/20', 'text-green-300', 'bg-red-500/20', 'text-red-300', 'bg-blue-500/20', 'text-blue-300');
    if (type === 'success') {
        statusDiv.classList.add('bg-green-500/20', 'text-green-300');
    } else if (type === 'error') {
        statusDiv.classList.add('bg-red-500/20', 'text-red-300');
    } else {
        statusDiv.classList.add('bg-blue-500/20', 'text-blue-300');
    }
    statusDiv.classList.remove('hidden');
}

// Zip code validation
document.getElementById('zipcode').addEventListener('input', function(e) {
    this.value = this.value.replace(/[^0-9]/g, '').slice(0, 5);
});

// Auto-geocode
function checkAutoGeocode() {
    const city = document.getElementById('city').value.trim();
    const state = document.getElementById('state').value;
    if (city && state) {
        clearTimeout(window.geocodeTimeout);
        window.geocodeTimeout = setTimeout(geocodeAddress, 1500);
    }
}
document.getElementById('city').addEventListener('blur', checkAutoGeocode);
document.getElementById('state').addEventListener('change', checkAutoGeocode);
document.getElementById('zipcode').addEventListener('blur', checkAutoGeocode);

// Toggle API fields
function toggleAPIFields() {
    const useAPI = document.getElementById('useapi').checked;
    const apiFields = document.getElementById('api-fields');
    apiFields.classList.toggle('hidden', !useAPI);
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    toggleAPIFields();
});

// Select all checkboxes
function toggleSelectAll(fromButton = false) {
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const jobCheckboxes = document.querySelectorAll('.job-checkbox');

    // If called from button, toggle the header checkbox first
    if (fromButton) {
        const anyUnchecked = Array.from(jobCheckboxes).some(cb => !cb.checked);
        selectAllCheckbox.checked = anyUnchecked; // Check all if any unchecked, else uncheck all
    }

    const isChecked = selectAllCheckbox.checked;
    jobCheckboxes.forEach(checkbox => { checkbox.checked = isChecked; });
    selectAllCheckbox.indeterminate = false;
}

// Get selected job IDs
function getSelectedJobIds() {
    const checkboxes = document.querySelectorAll('.job-checkbox:checked');
    return Array.from(checkboxes).map(cb => cb.value);
}

// Extract data from selected jobs
async function extractData(type) {
    const jobIds = getSelectedJobIds();
    if (jobIds.length === 0) {
        alert('Please select at least one completed job to extract data from.');
        return;
    }
    const format = document.getElementById('phone-format').value;
    try {
        const response = await fetch('/extract', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ job_ids: jobIds, type: type, format: format })
        });
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(errorText || 'Extraction failed');
        }
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `extracted_${type}_${new Date().toISOString().slice(0,10)}.txt`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        a.remove();
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// Upload CSV and extract
async function uploadAndExtract(type) {
    const fileInput = document.getElementById('csv-file');
    const file = fileInput.files[0];
    if (!file) {
        alert('Please select a CSV file first.');
        return;
    }
    if (!file.name.toLowerCase().endsWith('.csv')) {
        alert('Please select a valid CSV file.');
        return;
    }
    const format = document.getElementById('phone-format').value;
    const formData = new FormData();
    formData.append('csv_file', file);
    formData.append('type', type);
    formData.append('format', format);
    try {
        const response = await fetch('/upload-csv', {
            method: 'POST',
            body: formData
        });
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(errorText || 'Extraction failed');
        }
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `extracted_${type}_from_csv_${new Date().toISOString().slice(0,10)}.txt`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        a.remove();
        fileInput.value = '';
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// Update select all checkbox state
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('job-checkbox')) {
        const allCheckboxes = document.querySelectorAll('.job-checkbox');
        const checkedCheckboxes = document.querySelectorAll('.job-checkbox:checked');
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        if (allCheckboxes.length === checkedCheckboxes.length) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
        } else if (checkedCheckboxes.length === 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        } else {
            selectAllCheckbox.indeterminate = true;
        }
    }
});

// Extract data for GoPhish CSV format (from selected jobs)
async function extractForGophish(type) {
    const jobIds = getSelectedJobIds();
    if (jobIds.length === 0) {
        alert('Please select at least one completed job to extract data from.');
        return;
    }
    const format = document.getElementById('phone-format').value;
    try {
        const response = await fetch('/extract-gophish', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ job_ids: jobIds, type: type, format: format })
        });
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(errorText || 'Extraction failed');
        }
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `gophish_${type}_${new Date().toISOString().slice(0,10)}.csv`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        a.remove();
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// Update file count display for GoPhish batch upload
document.getElementById('csv-gophish-files').addEventListener('change', function() {
    const countEl = document.getElementById('csv-gophish-count');
    const count = this.files.length;
    if (count > 0) {
        countEl.textContent = count + ' file' + (count > 1 ? 's' : '') + ' selected';
        countEl.classList.remove('hidden');
    } else {
        countEl.classList.add('hidden');
    }
});

// Upload multiple CSVs and extract for GoPhish format (batch processing)
async function uploadForGophish(type) {
    const fileInput = document.getElementById('csv-gophish-files');
    const files = fileInput.files;
    if (files.length === 0) {
        alert('Please select at least one CSV file.');
        return;
    }
    // Validate all files are CSVs
    for (let i = 0; i < files.length; i++) {
        if (!files[i].name.toLowerCase().endsWith('.csv')) {
            alert('All files must be CSV files. Invalid file: ' + files[i].name);
            return;
        }
    }
    const format = document.getElementById('phone-format').value;
    const formData = new FormData();
    // Append all files
    for (let i = 0; i < files.length; i++) {
        formData.append('csv_files', files[i]);
    }
    formData.append('type', type);
    formData.append('format', format);
    try {
        const response = await fetch('/upload-gophish-batch', {
            method: 'POST',
            body: formData
        });
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(errorText || 'Extraction failed');
        }
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `gophish_${type}_batch_${new Date().toISOString().slice(0,10)}.csv`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        a.remove();
        fileInput.value = '';
        document.getElementById('csv-gophish-count').classList.add('hidden');
    } catch (error) {
        alert('Error: ' + error.message);
    }
}
</script>
</body>
</html>
